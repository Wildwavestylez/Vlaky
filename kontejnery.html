<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Kontejnerov√Ω termin√°l ‚Äî prototyp</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <style>
    :root{--panel-height:42%;--accent:#1f7ae0}
    html,body,#map{height:100%;margin:0;padding:0}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:#efefef}
    #map{position:fixed;left:0;right:0;top:0;bottom:0}
    .hamburger{position:fixed;left:12px;top:12px;z-index:1002;background:rgba(255,255,255,0.95);border-radius:10px;padding:8px;box-shadow:0 2px 8px rgba(0,0,0,0.2);}
    .hamburger button{border:0;background:none;font-size:20px;padding:6px}
    .panel{position:fixed;left:6px;right:6px;bottom:6px;height:var(--panel-height);background:rgba(255,255,255,0.98);border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,0.25);overflow:auto;z-index:1001;transform:translateY(100%);transition:transform .28s ease}
    .panel.open{transform:translateY(0%)}
    .panel .header{display:flex;align-items:center;justify-content:space-between;padding:10px;border-bottom:1px solid #eee}
    .panel .content{padding:10px}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .card{background:#fafafa;padding:8px;border-radius:8px;border:1px solid #eee}
    .container-item{padding:8px;margin:6px 0;border-radius:6px;background:#fff;border:1px solid #ddd;display:flex;justify-content:space-between;align-items:center}
    .btn{padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
    .btn.primary{background:var(--accent);color:#fff}
    .btn.positive{background:#2ecc71;color:#fff}
    .btn.warn{background:#f39c12;color:#fff}
    .btn.danger{background:#e74c3c;color:#fff}
    @media(min-width:900px){:root{--panel-height:360px}.panel{left:12px;right:auto;width:360px;bottom:12px;border-radius:14px}}
    .status-line{font-size:13px;color:#555}
    .small-muted{font-size:12px;color:#777}
    .legend{position:fixed;right:12px;top:12px;z-index:1002;background:rgba(255,255,255,0.95);padding:8px;border-radius:8px;border:1px solid #eee}
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="hamburger"><button id="hambBtn" aria-label="Menu">‚ò∞</button></div>
  <div class="legend">
    <div style="font-weight:600;margin-bottom:6px">Termin√°l</div>
    <div class="small-muted">Rychlost kamionu: 70 km/h<br>150 Kƒç / km ¬∑ 1. kamion zdarma ¬∑ dal≈°√≠ 100 000 Kƒç</div>
  </div>
  <div id="panel" class="panel" aria-hidden="true">
    <div class="header">
      <div style="font-weight:700">Kontejnerov√Ω termin√°l</div>
      <div><button id="closePanel" class="btn">‚úï</button></div>
    </div>
    <div class="content">
      <div class="row">
        <div class="card" style="flex:1 1 200px">
          <div style="font-weight:600">Finance</div>
          <div id="moneyDisplay" style="font-size:18px;margin-top:6px">Kƒç 0</div>
          <div class="small-muted" id="deliveredCount">Odvezeno: 0</div>
          <div style="margin-top:8px">
            <button id="buyTruckBtn" class="btn primary">Koupit kamion (100 000 Kƒç)</button>
          </div>
        </div>
        <div class="card" style="flex:1 1 200px">
          <div style="font-weight:600">Termin√°l</div>
          <div class="small-muted">Pozice: 49.1089704, 13.8666451</div>
          <div style="margin-top:8px">
            <button id="spawnTrainBtn" class="btn">Spustit vlak (test)</button>
            <button id="expandBtn" class="btn" style="margin-left:6px">Roz≈°√≠≈ôit +5 km</button>
          </div>
          <div style="margin-top:6px" class="small-muted">Aktu√°ln√≠ okruh: <span id="radiusDisplay">10</span> km</div>
        </div>
      </div>
      <hr />
      <div>
        <div style="font-weight:700">P≈ô√≠choz√≠ vlak</div>
        <div id="trainList"></div>
      </div>
      <hr />
      <div>
        <div style="font-weight:700">Mezisklad</div>
        <div id="warehouseList"></div>
      </div>
      <hr />
      <div>
        <div style="font-weight:700">Nastaven√≠ (pro dev/test)</div>
        <div class="small-muted">Interval p≈ô√≠chodu kontejneru (ms)</div>
        <input id="spawnIntervalInput" type="number" value="10000" style="width:120px;margin-top:6px" />
      </div>
      <div style="height:40px"></div>
    </div>
  </div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
    // ------------------ CONFIG ------------------
    const TERMINAL = {lat:49.1089704, lng:13.8666451};
    let fetchRadiusKm = 10;
    const KILOMETRE_PRICE = 315;
    const TRUCK_SPEED_KMH = 670;
    const FIRST_TRUCK_FREE = true;
    const OVERPASS_ENDPOINT = 'https://overpass-api.de/api/interpreter';
    // --------------------------------------------

    // state
    let map, terminalMarker;
    let towns = [];
    let trainQueue = [];
    let warehouse = [];
    let trucks = [];
    let money = 0;
    let deliveredCount = 0;
    let nextExpansionThreshold = 10;
       
let TRUCK_PRICE = 0;              
    const cargoTypes = [
  // --- Unie (27 st√°t≈Ø) ---
  {name:'N√°hradn√≠ d√≠ly', origin:'Nƒõmecko (EU)', value:'EU', eu:true},
  {name:'V√≠no', origin:'Francie (EU)', value:'EU', eu:true},
  {name:'Olivov√Ω olej', origin:'≈†panƒõlsko (EU)', value:'EU', eu:true},
  {name:'Makar√≥ny', origin:'It√°lie (EU)', value:'EU', eu:true},
  {name:'Pivo', origin:'ƒåesko (EU)', value:'EU', eu:true},
  {name:'Elektronick√© komponenty', origin:'Rakousko (EU)', value:'EU', eu:true},
  {name:'Maso', origin:'Polsko (EU)', value:'EU', eu:true},
  {name:'Ryby', origin:'Litva (EU)', value:'EU', eu:true},
  {name:'Ml√©ƒçn√© v√Ωrobky', origin:'Nizozemsko (EU)', value:'EU', eu:true},
  {name:'ƒåokol√°da', origin:'Belgie (EU)', value:'EU', eu:true},
  {name:'K√°va (pra≈æen√°)', origin:'Finsko (EU)', value:'EU', eu:true},
  {name:'Pap√≠r', origin:'≈†v√©dsko (EU)', value:'EU', eu:true},
  {name:'D≈ôevo', origin:'Estonsko (EU)', value:'EU', eu:true},
  {name:'Cement', origin:'Slovensko (EU)', value:'EU', eu:true},
  {name:'Chemik√°lie', origin:'Maƒèarsko (EU)', value:'EU', eu:true},
  {name:'Textil', origin:'Rumunsko (EU)', value:'EU', eu:true},
  {name:'Ocel', origin:'Lucembursko (EU)', value:'EU', eu:true},
  {name:'Farmaceutika', origin:'Irsko (EU)', value:'EU', eu:true},
  {name:'Tab√°kov√© v√Ωrobky', origin:'Bulharsko (EU)', value:'EU', eu:true},
  {name:'S√Ωry', origin:'D√°nsko (EU)', value:'EU', eu:true},
  {name:'Obuv', origin:'Portugalsko (EU)', value:'EU', eu:true},
  {name:'V√≠no Tokaj', origin:'Slovinsko (EU)', value:'EU', eu:true},
  {name:'Petrochemie', origin:'Chorvatsko (EU)', value:'EU', eu:true},
  {name:'Textiln√≠ vl√°kna', origin:'Loty≈°sko (EU)', value:'EU', eu:true},
  {name:'Farm√°≈ôsk√© produkty', origin:'≈òecko (EU)', value:'EU', eu:true},
  {name:'Softwarov√© servery', origin:'Kypr (EU)', value:'EU', eu:true},
  {name:'Hlin√≠k', origin:'Malta (EU)', value:'EU', eu:true},

  // --- Svƒõt (ne-EU) ---
  {name:'Levn√© obleƒçen√≠ (Temu)', origin:'ƒå√≠na', value:'mal√°', eu:false},
  {name:'Hraƒçky', origin:'ƒå√≠na', value:'mal√°', eu:false},
  {name:'Elektronika', origin:'Japonsko', value:'velk√°', eu:false},
  {name:'Auta', origin:'USA', value:'velk√°', eu:false},
  {name:'Auta', origin:'Kanada', value:'velk√°', eu:false},
  {name:'Auta', origin:'ƒå√≠na', value:'velk√°', eu:false},
  {name:'Auta', origin:'Austr√°lie', value:'velk√°', eu:false},
  {name:'Motorky', origin:'USA', value:'velk√°', eu:false},
  {name:'Motorky', origin:'Japonsko', value:'velk√°', eu:false},
  {name:'Motorky', origin:'Indie', value:'velk√°', eu:false},
  {name:'Motorky', origin:'Braz√≠lie', value:'velk√°', eu:false},
  {name:'Stroje', origin:'USA', value:'velk√°', eu:false},
  {name:'Stroje', origin:'Japonsko', value:'velk√°', eu:false},
  {name:'K√°va', origin:'Braz√≠lie', value:'velk√°', eu:false},
  {name:'Ban√°ny', origin:'Ekv√°dor', value:'velk√°', eu:false},
  {name:'ƒåaj', origin:'Indie', value:'mal√°', eu:false},
  {name:'ƒåaj', origin:'Sr√≠ Lanka', value:'mal√°', eu:false},
  {name:'Kakao', origin:'Pob≈ôe≈æ√≠ slonoviny', value:'velk√°', eu:false},
  {name:'Diamanty', origin:'Jihoafrick√° republika', value:'velk√°', eu:false},
  {name:'R√Ω≈æe', origin:'Vietnam', value:'velk√°', eu:false},
  {name:'R√Ω≈æe', origin:'Thajsko', value:'velk√°', eu:false},
  {name:'Avok√°do', origin:'Mexiko', value:'mal√°', eu:false},
  {name:'Mango', origin:'Peru', value:'mal√°', eu:false},
  {name:'Ko≈ôen√≠', origin:'Indon√©sie', value:'velk√°', eu:false},
  {name:'Kiwi', origin:'Nov√Ω Z√©land', value:'velk√°', eu:false},
  {name:'Datle', origin:'Tunisko', value:'velk√°', eu:false},
  {name:'F√≠ky', origin:'Turecko', value:'velk√°', eu:false},
  {name:'Gran√°tov√° jablka', origin:'√çr√°n', value:'velj√°', eu:false},
  {name:'Ananasy', origin:'Kostarika', value:'velk√°', eu:false},
  {name:'Pap√°ja', origin:'Dominik√°nsk√° republika', value:'velk√°', eu:false},
  {name:'Durian', origin:'Malajsie', value:'mal√°', eu:false}, // smradlav√Ω kr√°l ovoce üòÖ
  {name:'Jackfruit', origin:'Banglad√©≈°', value:'velk√°', eu:false},
  {name:'Liƒçi', origin:'ƒå√≠na', value:'velk√°', eu:false},
  {name:'Mangostan', origin:'Thajsko', value:'velk√°', eu:false},
  {name:'Chilli papriƒçky', origin:'Mexiko', value:'velk√°', eu:false},
  {name:'Vanilka', origin:'Madagaskar', value:'velk√°', eu:false},
  {name:'≈†afr√°n', origin:'√çr√°n', value:'velk√°', eu:false},
  {name:'Kardamom', origin:'Guatemala', value:'mal√°', eu:false},
  {name:'Z√°zvor', origin:'Nig√©rie', value:'velk√°', eu:false},
  {name:'Tamarind', origin:'Indie', value:'mal√°', eu:false},
  {name:'Chininov√° k≈Øra', origin:'Bol√≠vie', value:'velk√°', eu:false}, // z√°klad toniku
  {name:'Yerba mat√©', origin:'Paraguay', value:'velk√°', eu:false},
  {name:'Kokosy', origin:'Filip√≠ny', value:'velk√°', eu:false},
  {name:'Mo≈ôsk√© ≈ôasy', origin:'Japonsko', value:'mal√°', eu:false},
  {name:'Losos chlazen√Ω', origin:'Norsko', value:'velk√°', eu:false},
  {name:'Hum≈ôi', origin:'Kanada', value:'velk√°', eu:false},
  {name:'Perly', origin:'Tahiti', value:'velk√°', eu:false},
  {name:'K≈Ø≈æe z alig√°tor≈Ø', origin:'Florida (USA)', value:'velk√°', eu:false},
  {name:'ƒåaj Pu-erh', origin:'ƒå√≠na (Yunnan)', value:'mal√°', eu:false},
  {name:'Basmati r√Ω≈æe', origin:'P√°kist√°n', value:'velk√°', eu:false},
  {name:'Tequila', origin:'Mexiko', value:'velk√°', eu:false},
  {name:'Rum', origin:'Kuba', value:'velk√°', eu:false},
  {name:'Whisky', origin:'Skotsko', value:'velk√°', eu:false},
  {name:'Sake', origin:'Japonsko', value:'velk√°', eu:false},
  {name:'K√°va Kopi Luwak', origin:'Indon√©sie', value:'velk√°', eu:false}, // luxusn√≠ k√°va
  {name:'Kakaov√© boby', origin:'Ghana', value:'velk√°', eu:false},
  {name:'Lan√Ω≈æe', origin:'Francie', value:'velk√°', eu:true},
  {name:'Kameny jadeit', origin:'Myanmar', value:'velk√°', eu:false},
  {name:'Turmal√≠ny', origin:'Mosambik', value:'mal√°', eu:false},
  {name:'Koralov√© ≈°perky', origin:'Filip√≠ny', value:'velk√°', eu:false},
  {name:'Televize a monitory', origin:'Ji≈æn√≠ Korea', value:'velk√°', eu:false},
  {name:'Notebooky a poƒç√≠taƒçe', origin:'Tchaj-wan', value:'velk√°', eu:false},
  {name:'Mobiln√≠ telefony', origin:'ƒå√≠na', value:'velk√°', eu:false},
  {name:'Sol√°rn√≠ panely', origin:'Vietnam', value:'velk√°', eu:false},
  {name:'Vƒõtrn√© turb√≠ny (ƒç√°sti)', origin:'ƒå√≠na', value:'velk√°', eu:false},
  {name:'Leteck√© motory', origin:'USA', value:'velk√°', eu:false},
  {name:'D√≠ly pro rakety', origin:'USA', value:'velk√°', eu:false},
  {name:'Lodn√≠ motory', origin:'Japonsko', value:'velk√°', eu:false},
  {name:'Buldozery', origin:'USA', value:'velk√°', eu:false},
  {name:'Bagry', origin:'Japonsko', value:'velk√°', eu:false},
  {name:'Traktory', origin:'Kanada', value:'velk√°', eu:false},
  {name:'Lokomotivn√≠ d√≠ly', origin:'Indie', value:'velk√°', eu:false},
  {name:'Elektrick√© lokomotivy', origin:'ƒå√≠na', value:'velk√°', eu:false},
  {name:'Vysokozdvi≈æn√© voz√≠ky', origin:'Japonsko', value:'velk√°', eu:false},
  {name:'3D tisk√°rny pr≈Ømyslov√©', origin:'USA', value:'velk√°', eu:false},
  {name:'Robotick√° ramena', origin:'Ji≈æn√≠ Korea', value:'velk√°', eu:false},
  {name:'Pr≈Ømyslov√© lasery', origin:'Japonsko', value:'velk√°', eu:false},
  {name:'Turb√≠ny pro elektr√°rny', origin:'Rusko', value:'velk√°', eu:false},
  {name:'Gener√°tory', origin:'Kanada', value:'velk√°', eu:false},
  {name:'Transform√°tory', origin:'ƒå√≠na', value:'velk√°', eu:false},
  {name:'Vysokokapacitn√≠ baterie', origin:'Ji≈æn√≠ Korea', value:'velk√°', eu:false},
  {name:'Autobusy', origin:'ƒå√≠na', value:'velk√°', eu:false},
  {name:'Elektrobusy', origin:'Indie', value:'velk√°', eu:false},
  {name:'Elektrick√© sk√∫try', origin:'Tchaj-wan', value:'velk√°', eu:false},
  {name:'Sanitky vybaven√©', origin:'USA', value:'velk√°', eu:false},
  {name:'V√Ωrobn√≠ linky (moduly)', origin:'Japonsko', value:'velk√°', eu:false},
  {name:'Vrtn√© soupravy', origin:'USA', value:'velk√°', eu:false},
  {name:'Chlad√≠c√≠ za≈ô√≠zen√≠ pro datacentra', origin:'Singapur', value:'velk√°', eu:false},
  {name:'Servery a datov√° √∫lo≈æi≈°tƒõ', origin:'USA', value:'velk√°', eu:false},
  {name:'L√©ka≈ôsk√© p≈ô√≠stroje (CT/MRI)', origin:'Japonsko', value:'velk√°', eu:false},
  {name:'Dialyzaƒçn√≠ jednotky', origin:'Indie', value:'velk√°', eu:false},
  {name:'Farmaceutick√© stroje', origin:'≈†v√Ωcarsko', value:'velk√°', eu:false}, // i kdy≈æ ≈†v√Ωc. nen√≠ EU
  {name:'Balen√© ƒçipy', origin:'Tchaj-wan', value:'velk√°', eu:false},
  {name:'Polovodiƒçov√© stroje', origin:'Nizozemsko', value:'EU', eu:true}, // EU specialita
  {name:'Ropn√© pumpy a ventily', origin:'Sa√∫dsk√° Ar√°bie', value:'velk√°', eu:false},
  {name:'Vod√≠kov√© ƒçl√°nky', origin:'Kanada', value:'velk√°', eu:false},
  {name:'Elektrick√© kabely vysok√©ho napƒõt√≠', origin:'Turecko', value:'velk√°', eu:false},
  {name:'Podmo≈ôsk√© kabely', origin:'USA', value:'velk√°', eu:false}
];

    function initMap(){
      map = L.map('map').setView([TERMINAL.lat, TERMINAL.lng], 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
        {attribution:'¬© OSM'}).addTo(map);
      terminalMarker = L.circleMarker([TERMINAL.lat, TERMINAL.lng],
        {radius:8, color:'#2c3e50', fillColor:'#1f7ae0', fillOpacity:1}
      ).addTo(map).bindTooltip('Termin√°l');
    }
    initMap();

    // ----------- Overpass fetch ----------
    async function fetchTowns(radiusKm){
      towns = [];
      const radiusM = Math.round(radiusKm * 1000);
      const q = `
[out:json][timeout:25];
(
  node["place"~"town|village"](around:${radiusM},${TERMINAL.lat},${TERMINAL.lng});
  way["place"~"town|village"](around:${radiusM},${TERMINAL.lat},${TERMINAL.lng});
);
out center;`;
      try{
        const resp = await fetch(OVERPASS_ENDPOINT, {method:'POST',body:q});
        const data = await resp.json();
        data.elements.forEach(el=>{
          let lat = el.lat || (el.center && el.center.lat);
          let lon = el.lon || (el.center && el.center.lon);
          let name = el.tags && (el.tags.name || el.tags['name:cs'] || el.tags['name:en']);
          if(name && lat && lon){ towns.push({name, lat, lng:lon}); }
        });
        const unique = {};
        towns = towns.filter(t=>{if(unique[t.name]) return false; unique[t.name]=true; return true;});
      }catch(err){ console.error(err); }
    }
    fetchTowns(fetchRadiusKm);

    // ----------- helpers ----------
    function haversineKm(a,b){
      const R = 6371; const toRad = x=>x*Math.PI/180;
      const dLat = toRad(b.lat-a.lat); const dLon = toRad(b.lng-a.lng);
      const lat1 = toRad(a.lat), lat2 = toRad(b.lat);
      const hav = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
      return R*2*Math.atan2(Math.sqrt(hav), Math.sqrt(1-hav));
    }
    function randFrom(arr){return arr[Math.floor(Math.random()*arr.length)];}

    // ----------- containers ----------
    let spawnInterval = 30000;
    let spawnTimer = null;
    function spawnContainer(){
      const cargo = {...randFrom(cargoTypes), id:Date.now()+Math.random()};
      trainQueue.push(cargo); renderTrainList();
    }
    function startSpawning(){
      if(spawnTimer) clearInterval(spawnTimer);
      spawnTimer = setInterval(spawnContainer, spawnInterval);
      spawnContainer();
    }
    document.getElementById('spawnIntervalInput').addEventListener('change', e=>{
      spawnInterval = Number(e.target.value) || 10000; startSpawning();
    });
    document.getElementById('spawnTrainBtn').addEventListener('click', ()=>spawnContainer());

    function renderTrainList(){
      const el = document.getElementById('trainList');
      el.innerHTML='';
      trainQueue.forEach(c=>{
        const div = document.createElement('div');
        div.className='container-item';
        div.innerHTML = `<div><strong>${c.name}</strong><div class="small-muted">${c.origin} ¬∑ hodn: ${c.value}</div></div>
                         <div><button class="btn" onclick='openPapers("${c.id}")'>Pap√≠ry</button></div>`;
        el.appendChild(div);
      });
    }

    // ---------- papers modal ----------
    let currentContainer = null;
    function openPapers(id){
      const cont = trainQueue.find(x=>String(x.id)===String(id));
      if(!cont) return;
      currentContainer = cont;
      const html = `
        <div style="position:fixed;left:10px;right:10px;top:50%;transform:translateY(-50%);z-index:2000;background:#fff;padding:12px;border-radius:12px;box-shadow:0 8px 20px rgba(0,0,0,0.3)" id="paperModal">
          <div style="font-weight:700;margin-bottom:6px">Pap√≠ry ‚Äî ${cont.name}</div>
          <div class="small-muted">P≈Øvod: ${cont.origin} ¬∑ Hodnota: ${cont.value}</div>
          <div style="margin-top:8px;display:flex;gap:8px">
            <button id="btnNo" class="btn">Nevycl√≠t</button>
            <button id="btnSelf" class="btn positive">Vycl√≠t s√°m</button>
            <button id="btnOffice" class="btn warn">Poslat na √∫≈ôad</button>
            <button id="btnCloseModal" class="btn">Zav≈ô√≠t</button>
          </div>
        </div>`;
      const wrapper = document.createElement('div'); wrapper.innerHTML = html; document.body.appendChild(wrapper);
      document.getElementById('btnCloseModal').onclick = ()=>{document.getElementById('paperModal').remove(); currentContainer=null};
      document.getElementById('btnNo').onclick = ()=>{processContainer('nevyclit')};
      document.getElementById('btnSelf').onclick = ()=>{processContainer('sam')};
      document.getElementById('btnOffice').onclick = ()=>{processContainer('urad')};
    }

    function assignDestination(container){
      if (towns.length === 0) return container;
      const town = randFrom(towns);
      const dist = haversineKm(TERMINAL, town);
      container.destination = town.name;
      container.dist = dist.toFixed(1);
      container.reward = Math.round(dist * KILOMETRE_PRICE);
      return container;
    }

    function processContainer(method){
      if(!currentContainer) return;
      const cont = currentContainer;
      const modal = document.getElementById('paperModal'); if(modal) modal.remove();
      if(method==='nevyclit'){
        if(cont.eu){ moveToWarehouse(cont); alert('Nevycleno ‚Äî p≈ôijato do skladu'); }
        else{ alert('Toto nelze nevycl√≠t (nen√≠ EU)'); }
      }else if(method==='sam'){
        if(cont.value==='mal√°'){ moveToWarehouse(cont); alert('Vycleno vlastn√≠ cestou ‚Äî do skladu'); }
        else{ sendToOffice(cont); alert('Velk√° hodnota ‚Äî pos√≠l√°m na √∫≈ôad'); }
      }else if(method==='urad'){ sendToOffice(cont); alert('Odesl√°no na √∫≈ôad...'); }
      trainQueue = trainQueue.filter(t=>t.id!==cont.id); renderTrainList();
    }

    function moveToWarehouse(container){
      assignDestination(container);
      warehouse.push(container);
      renderWarehouse();
    }
    function sendToOffice(container){
  const delay = 50000 + Math.random()*12000;
  setTimeout(()=>{
    assignDestination(container);
    moveToWarehouse(container);
    renderTrainList();
    renderWarehouse();
    // alert(container.name + ' ‚Äî vycleno √∫≈ôadem');  // zbyteƒçn√©
  }, delay);
}

    function renderWarehouse(){
      const el = document.getElementById('warehouseList');
      if(!el) return;
      el.innerHTML = '';
      warehouse.forEach((c, idx)=>{
        const div = document.createElement('div');
        div.className = 'container-item';
        div.innerHTML = `
          <div>
            <strong>${c.name}</strong>
            <div class="small-muted">${c.origin} ¬∑ ${c.eu ? 'EU' : 'mimo EU'} ¬∑ hodn: ${c.value}</div>
            <div class="small-muted">Destinace: ${c.destination}<br>${c.dist} km ¬∑ ${c.reward} Kƒç</div>
          </div>
          <div><button class="btn primary" onclick="assignToTruck(${idx})">Nalo≈æit</button></div>
        `;
        el.appendChild(div);
      });
    }

    // ---------- trucks ----------
    let TRUCK_PRICE_BASE = 15000;     // cena druh√©ho kamionu
let TRUCK_PRICE_STEP = 5000;     // o kolik se zvy≈°uje cena dal≈°√≠ho


function createTruck(isFree=false){
  const truck = {
    id: Date.now()+Math.random(),
    lat: TERMINAL.lat,
    lng: TERMINAL.lng,
    status: 'idle',
    marker: null
  };
  truck.marker = L.circleMarker([truck.lat, truck.lng], {
    radius: 6,
    color: '#000',
    fillColor: '#f39c12',
    fillOpacity: 1
  }).addTo(map).bindTooltip('Kamion');
  trucks.push(truck);
  return truck;
}

// prvn√≠ kamion zdarma
if(FIRST_TRUCK_FREE) createTruck(true);

// tlaƒç√≠tko pro n√°kup
document.getElementById('buyTruckBtn').addEventListener('click', ()=>{
  // cena se urƒç√≠ podle poƒçtu kamion≈Ø (prvn√≠ zdarma, druh√Ω 20k, t≈ôet√≠ 40k, ‚Ä¶)
  const trucksOwned = trucks.length;
  TRUCK_PRICE = trucksOwned === 0 ? 0 : TRUCK_PRICE_BASE + TRUCK_PRICE_STEP * (trucksOwned - 1);

  if(money < TRUCK_PRICE){
    alert('Nem√°≈° dost penƒõz');
    return;
  }
  money -= TRUCK_PRICE;
  updateUI();
  createTruck(false);
  alert(`Koupil jsi nov√Ω kamion za ${TRUCK_PRICE} Kƒç`);
});
    function findIdleTruck(){ return trucks.find(t=>t.status==='idle'); }

    async function assignToTruck(warehouseIndex){  
  const cont = warehouse[warehouseIndex];  
  if(!cont) return;  

  const truck = findIdleTruck();  
  if(!truck){ 
    alert('≈Ω√°dn√Ω voln√Ω kamion'); 
    return;  
  }  

  const destTown = towns.find(t=>t.name===cont.destination);  

  // ihned odeber kontejner z meziskladu (po nalo≈æen√≠), i kdy≈æ destinace neplatn√°
  warehouse.splice(warehouseIndex, 1);  
  renderWarehouse();  
  updateUI();  

  if(!destTown){ 
    alert('Destinace nenalezena ‚Äì kontejner odstranƒõn'); 
    return;  
  }  

  const distKm = parseFloat(cont.dist);  

  // move truck
  truck.status = 'busy';  
  updateTruckMarker(truck);  

  driveTruck(truck, {lat: destTown.lat, lng: destTown.lng}, distKm, () => {  
    // arrived at destination  
    money += cont.reward;  
    deliveredCount += 1;  
    updateUI();  
    alert(`Doruƒçeno do ${cont.destination} ‚Äî z√≠sk√°no Kƒç ${cont.reward} (vzd√°lenost ${distKm.toFixed(1)} km)`);  

    // check expansion threshold  
    if (deliveredCount >= nextExpansionThreshold) {  
      fetchRadiusKm += 5;  
      document.getElementById('radiusDisplay').innerText = fetchRadiusKm;  
      fetchTowns(fetchRadiusKm);  
      nextExpansionThreshold += 10;  
      alert('Okruh roz≈°√≠≈ôen o 5 km ‚Äî nov√© obce naƒçteny');  
    }  

    // return to terminal  
    driveTruck(truck, {lat: TERMINAL.lat, lng: TERMINAL.lng}, distKm, () => {  
      truck.status = 'idle';  
      truck.lat = TERMINAL.lat;  
      truck.lng = TERMINAL.lng;  
      updateTruckMarker(truck);  
    });  
  });  
}
    // update marker position & tooltip
    function updateTruckMarker(truck){
      if(!truck.marker) return;
      truck.marker.setLatLng([truck.lat, truck.lng]);
      truck.marker.bindTooltip(truck.status, {permanent:false});
    }

    // simple straight-line drive animation using requestAnimationFrame
    function driveTruck(truck, destLatLng, distKm, onArrive){
      const start = {lat: truck.lat, lng: truck.lng};
      const totalKm = distKm;
      // compute travel time based on truck speed
      const hours = Math.max(0.001, totalKm / TRUCK_SPEED_KMH);
      const durationMs = Math.max(500, hours * 3600 * 1000); // at least 500ms for short trips
      const t0 = performance.now();

      function step(now){
        const p = Math.min(1, (now - t0) / durationMs);
        const lat = start.lat + (destLatLng.lat - start.lat) * p;
        const lng = start.lng + (destLatLng.lng - start.lng) * p;
        truck.lat = lat;
        truck.lng = lng;
        updateTruckMarker(truck);
        if (p < 1) {
          requestAnimationFrame(step);
        } else {
          onArrive && onArrive();
        }
      }
      requestAnimationFrame(step);
    }

    // UI updates
    function updateUI(){
      document.getElementById('moneyDisplay').innerText = `Kƒç ${money.toLocaleString('cs-CZ')}`;
      document.getElementById('deliveredCount').innerText = `Odvezeno: ${deliveredCount}`;
      document.getElementById('radiusDisplay').innerText = fetchRadiusKm;
    }

    // panel toggles
    const panel = document.getElementById('panel');
    document.getElementById('hambBtn').addEventListener('click', ()=>{
      panel.classList.toggle('open');
      panel.setAttribute('aria-hidden', String(!panel.classList.contains('open')));
    });
    document.getElementById('closePanel').addEventListener('click', ()=>{
      panel.classList.remove('open');
      panel.setAttribute('aria-hidden', 'true');
    });

    // manual expand
    document.getElementById('expandBtn').addEventListener('click', ()=>{
      fetchRadiusKm += 5;
      document.getElementById('radiusDisplay').innerText = fetchRadiusKm;
      fetchTowns(fetchRadiusKm);
      alert('Okruh ruƒçnƒõ roz≈°√≠≈ôen +5 km');
    });

    // expose functions for inline onclicks
    window.assignToTruck = assignToTruck;
    window.openPapers = openPapers;

    // start processes
    startSpawning();
    updateUI();

  </script>
</body>
</html>